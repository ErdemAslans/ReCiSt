apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: selfhealingpolicies.recist.io
spec:
  group: recist.io
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                targetNamespaces:
                  type: array
                  items:
                    type: string
                targetLabels:
                  type: object
                  additionalProperties:
                    type: string
                thresholds:
                  type: object
                  properties:
                    cpu:
                      type: number
                    memory:
                      type: number
                    latencyMs:
                      type: integer
                    errorRate:
                      type: number
                allowedActions:
                  type: array
                  items:
                    type: string
                    enum: ["restart", "scale", "updateConfig", "updateResources", "isolate"]
                llmConfig:
                  type: object
                  properties:
                    provider:
                      type: string
                      enum: ["claude", "openai", "gemini", "ollama"]
                    model:
                      type: string
                    apiKeySecret:
                      type: string
                    timeoutSeconds:
                      type: integer
                    baseUrl:
                      type: string
            status:
              type: object
              properties:
                observedGeneration:
                  type: integer
                activeHealings:
                  type: integer
                lastHealingTime:
                  type: string
                totalHealings:
                  type: integer
                successfulHealings:
                  type: integer
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      lastTransitionTime:
                        type: string
                      reason:
                        type: string
                      message:
                        type: string
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Active Healings
          type: integer
          jsonPath: .status.activeHealings
        - name: Last Healing
          type: date
          jsonPath: .status.lastHealingTime
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
  scope: Namespaced
  names:
    plural: selfhealingpolicies
    singular: selfhealingpolicy
    kind: SelfHealingPolicy
    shortNames:
      - shp
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: healingevents.recist.io
spec:
  group: recist.io
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                policyRef:
                  type: string
                targetPod:
                  type: string
                targetNamespace:
                  type: string
                triggerReason:
                  type: string
                  enum: ["highCpu", "highMemory", "highLatency", "highErrorRate", "crashLoop", "oomKilled", "networkError", "dependencyFailure", "unknown"]
                triggerMetrics:
                  type: object
                  properties:
                    cpuUsage:
                      type: number
                    memoryUsage:
                      type: number
                    latencyMs:
                      type: integer
                    errorRate:
                      type: number
                    restartCount:
                      type: integer
            status:
              type: object
              properties:
                phase:
                  type: string
                  enum: ["Pending", "Containing", "Diagnosing", "Healing", "Verifying", "Completed", "Failed"]
                startTime:
                  type: string
                endTime:
                  type: string
                durationMs:
                  type: integer
                diagnosis:
                  type: object
                  properties:
                    hypothesis:
                      type: string
                    confidence:
                      type: number
                    rootCause:
                      type: string
                    evidence:
                      type: array
                      items:
                        type: string
                appliedActions:
                  type: array
                  items:
                    type: object
                    properties:
                      actionType:
                        type: string
                      timestamp:
                        type: string
                      result:
                        type: string
                      details:
                        type: string
                outcome:
                  type: object
                  properties:
                    success:
                      type: boolean
                    message:
                      type: string
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Target Pod
          type: string
          jsonPath: .spec.targetPod
        - name: Reason
          type: string
          jsonPath: .spec.triggerReason
        - name: Success
          type: boolean
          jsonPath: .status.outcome.success
        - name: Duration
          type: string
          jsonPath: .status.durationMs
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
  scope: Namespaced
  names:
    plural: healingevents
    singular: healingevent
    kind: HealingEvent
    shortNames:
      - he
